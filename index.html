<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√†m B√†i Chi Ti·∫øt</title>
    <link rel="stylesheet" href="style.css">
    <script>
        window.MathJax = {
            tex: { 
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                tags: 'ams'
            },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">‚Üê Tr·ªü v·ªÅ danh s√°ch</a>
        <div id="noidung-hienthi"><h2 style="text-align:center;">ƒêang t·∫£i n·ªôi dung...</h2></div>
    </div>

    <script>
        let currentProblem = null;

        // H√†m d·ªãch danh s√°ch LaTeX (ƒê√£ b·ªè l·ªánh replace \ th√†nh <br> g√¢y l·ªói)
        function parseLaTeXText(text) {
            if (!text) return "";
            return text
                .replace(/\\begin\{itemize\}/g, "<ul class='latex-list' style='margin-left: 20px; margin-bottom: 10px;'>")
                .replace(/\\end\{itemize\}/g, "</ul>")
                .replace(/\\begin\{enumerate\}/g, "<ol class='latex-list' style='margin-left: 20px; margin-bottom: 10px;'>")
                .replace(/\\end\{enumerate\}/g, "</ol>")
                .replace(/\\item/g, "<li>");
        }

        const urlParams = new URLSearchParams(window.location.search);
        const baiId = urlParams.get('id');

        if (!baiId) {
            document.getElementById('noidung-hienthi').innerHTML = '<h2>‚ùå Li√™n k·∫øt kh√¥ng h·ª£p l·ªá!</h2>';
        } else {
            fetch('data.json')
                .then(res => res.json())
                .then(data => {
                    currentProblem = data.find(item => item.id === baiId);
                    if (currentProblem) renderGiaoDien(currentProblem);
                    else document.getElementById('noidung-hienthi').innerHTML = '<h2>‚ùå Kh√¥ng t√¨m th·∫•y b√†i to√°n.</h2>';
                });
        }

        function renderGiaoDien(baiToan) {
            let formKiemTra = '';
            const cauHoiDaXuLy = parseLaTeXText(baiToan.cau_hoi);
            const loiGiaiDaXuLy = parseLaTeXText(baiToan.loi_giai);

            // D·∫°ng 1: 4 Ph∆∞∆°ng √°n
            if (baiToan.loai_cau === '4_phuong_an') {
                const lis = baiToan.lua_chon.map(opt => {
                    const letter = opt.charAt(0);
                    const textDaXuLy = parseLaTeXText(opt.substring(3));
                    return `<li style="list-style:none; margin-bottom:8px;">
                                <label style="cursor:pointer; display:block; padding:15px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:5px;">
                                    <input type="radio" name="q" value="${letter}" style="transform: scale(1.2); margin-right:8px;"> 
                                    <b>${letter}.</b> ${textDaXuLy}
                                </label>
                            </li>`;
                }).join('');
                formKiemTra = `<div class="answer-section"><h3>Ch·ªçn ƒë√°p √°n ƒë√∫ng:</h3><ul class="options-4" style="padding:0;">${lis}</ul></div>`;
            } 
            // D·∫°ng 2: ƒê√∫ng/Sai
            else if (baiToan.loai_cau === 'dung_sai') {
                const rows = baiToan.cac_menh_de.map((md, idx) => {
                    const mdDaXuLy = parseLaTeXText(md.noi_dung);
                    return `<tr>
                                <td style="padding:12px; border:1px solid #e2e8f0;">${mdDaXuLy}</td>
                                <td style="text-align:center; border:1px solid #e2e8f0;"><input type="radio" name="ds-${idx}" value="true" style="transform: scale(1.3);"> ƒê</td>
                                <td style="text-align:center; border:1px solid #e2e8f0;"><input type="radio" name="ds-${idx}" value="false" style="transform: scale(1.3);"> S</td>
                            </tr>`;
                }).join('');
                formKiemTra = `<div class="answer-section"><h3>Ch·ªçn ƒê√∫ng/Sai:</h3>
                               <table class="table-tf" style="width:100%; border-collapse:collapse; background:white;">
                                  <tr style="background:#3b82f6; color:white;">
                                      <th style="padding:12px; border:1px solid #e2e8f0; text-align:left;">M·ªánh ƒë·ªÅ</th>
                                      <th style="padding:12px; border:1px solid #e2e8f0; width:60px;">ƒê√∫ng</th>
                                      <th style="padding:12px; border:1px solid #e2e8f0; width:60px;">Sai</th>
                                  </tr>${rows}
                               </table></div>`;
            } 
            // D·∫°ng 3: Tr·∫£ l·ªùi ng·∫Øn
            else if (baiToan.loai_cau === 'tra_loi_ngan') {
                formKiemTra = `<div class="answer-section"><h3>Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n:</h3>
                               <input type="text" id="user-answer" class="input-short" placeholder="Nh·∫≠p k·∫øt qu·∫£..." style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:8px; font-size:16px;"></div>`;
            }

            let youtubeHTML = (baiToan.youtube_id && baiToan.youtube_id !== "") 
                ? `<div class="video-container" style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:8px; margin-top:20px;">
                       <iframe style="position:absolute; top:0; left:0; width:100%; height:100%;" src="https://www.youtube.com/embed/${baiToan.youtube_id}" allowfullscreen></iframe>
                   </div>` : '';

            document.getElementById('noidung-hienthi').innerHTML = `
                <div class="content-box" style="background:white; padding:32px; border-radius:12px; border:1px solid #e2e8f0; box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-bottom:24px;">
                    <div class="badges"><span class="badge badge-blue">${baiToan.ky_thi}</span></div>
                    <h2 class="question-title" style="margin-top:10px; margin-bottom:20px; border-bottom:2px solid #e2e8f0; padding-bottom:10px;">N·ªôi dung b√†i to√°n</h2>
                    <div class="question-content" style="font-size:1.1rem;">${cauHoiDaXuLy}</div>
                </div>
                
                ${formKiemTra}
                
                <div style="display:flex; gap:10px; margin-bottom:24px;">
                    <button class="btn-check" onclick="checkAnswer()" style="flex:1; background:#10b981; color:white; border:none; padding:14px; border-radius:8px; font-weight:bold; cursor:pointer;">Ki·ªÉm Tra ƒê√°p √Ån</button>
                    <button class="btn-solve" onclick="toggleSolution()" style="flex:1; background:#3b82f6; color:white; border:none; padding:14px; border-radius:8px; font-weight:bold; cursor:pointer;">Xem L·ªùi Gi·∫£i</button>
                </div>
                
                <div id="feedback-msg" class="feedback-msg" style="margin-bottom:20px; text-align:center; font-size:1.1rem; font-weight:bold;"></div>
                
                <div id="loi-giai" class="solution-box" style="display:none; background:#f0fdf4; border-left:4px solid #10b981; padding:24px; border-radius:0 8px 8px 0;">
                    <h3 style="color:#10b981; margin-bottom:15px;">Th√¥ng tin chi ti·∫øt</h3>
                    <div class="solution-content">${loiGiaiDaXuLy}</div>
                    ${youtubeHTML}
                </div>
            `;

            if (window.MathJax) MathJax.typesetPromise();
        }

        window.checkAnswer = function() {
            const feedbackEl = document.getElementById('feedback-msg');
            let isCorrect = false;

            if (currentProblem.loai_cau === '4_phuong_an') {
                const selected = document.querySelector(`input[name="q"]:checked`);
                if (!selected) return feedbackEl.innerHTML = '<span style="color:#f59e0b;">‚ö†Ô∏è Vui l√≤ng ch·ªçn 1 ƒë√°p √°n!</span>';
                if (selected.value === currentProblem.dap_an) isCorrect = true;
            } 
            else if (currentProblem.loai_cau === 'dung_sai') {
                let correctCount = 0; let allAnswered = true;
                currentProblem.cac_menh_de.forEach((md, idx) => {
                    const selected = document.querySelector(`input[name="ds-${idx}"]:checked`);
                    if (!selected) allAnswered = false;
                    else if ((selected.value === 'true') === md.dap_an) correctCount++;
                });
                if (!allAnswered) return feedbackEl.innerHTML = '<span style="color:#f59e0b;">‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒê/S cho t·∫•t c·∫£ m·ªánh ƒë·ªÅ!</span>';
                if (correctCount === currentProblem.cac_menh_de.length) isCorrect = true;
                else return feedbackEl.innerHTML = `<span style="color:#ef4444;">‚ùå B·∫°n l√†m ƒë√∫ng ${correctCount}/${currentProblem.cac_menh_de.length} √Ω.</span>`;
            } 
            else if (currentProblem.loai_cau === 'tra_loi_ngan') {
                const inputVal = document.getElementById(`user-answer`).value.trim();
                if (inputVal === '') return feedbackEl.innerHTML = '<span style="color:#f59e0b;">‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë√°p √°n!</span>';
                if (inputVal.toLowerCase().replace(/\s/g, '') === currentProblem.dap_an_ngan.toLowerCase().replace(/\s/g, '')) isCorrect = true;
            }

            if (isCorrect) {
                feedbackEl.innerHTML = '<span style="color:#10b981;">üéâ Ch√≠nh x√°c! B·∫°n l√†m r·∫•t t·ªët!</span>';
                
                // L∆∞u tr·∫°ng th√°i ho√†n th√†nh v√†o LocalStorage
                let saved = localStorage.getItem('toan_completed');
                let completed = saved ? JSON.parse(saved) : [];
                if (!completed.includes(currentProblem.id)) {
                    completed.push(currentProblem.id);
                    localStorage.setItem('toan_completed', JSON.stringify(completed));
                }
            } else {
                feedbackEl.innerHTML = '<span style="color:#ef4444;">‚ùå Sai r·ªìi, b·∫°n h√£y t√≠nh to√°n l·∫°i nh√©!</span>';
            }
        };

        window.toggleSolution = function() {
            const solBox = document.getElementById('loi-giai');
            solBox.style.display = (solBox.style.display === 'none' || solBox.style.display === '') ? 'block' : 'none';
        };
    </script>
</body>
</html>
