<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ng√¢n H√†ng To√°n THPT & ƒêGNL</title>
    
    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
    <script src="https://tikzjax.com/v1/tikzjax.js"></script>

    <script>
        window.MathJax = {
            tex: { 
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                tags: 'ams' // H·ªó tr·ª£ ƒë√°nh s·ªë ph∆∞∆°ng tr√¨nh t·ª± ƒë·ªông
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>H·ªá Th·ªëng Luy·ªán Thi To√°n</h1>
            <p>√în luy·ªán to√†n di·ªán THPT Qu·ªëc Gia & ƒê√°nh Gi√° NƒÉng L·ª±c</p>
        </div>

        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'THPT')" id="defaultOpen">K·ª≥ thi THPT Qu·ªëc Gia</button>
            <button class="tablinks" onclick="openTab(event, 'DGNL')">ƒê√°nh Gi√° NƒÉng L·ª±c</button>
        </div>

        <button class="reset-btn" onclick="resetProgress()" style="display: block; margin: 0 auto 20px auto; background: #e2e8f0; color: #475569; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;">X√≥a l·ªãch s·ª≠ l√†m b√†i</button>

        <div id="THPT" class="tabcontent"></div>
        <div id="DGNL" class="tabcontent"></div>
    </div>

    <script>
        let problemsData = []; 

        // --- H√ÄM D·ªäCH TEXT LATEX SANG HTML (itemize, enumerate) ---
        function parseLaTeXText(text) {
            if (!text) return "";
            return text
                .replace(/\\begin\{itemize\}/g, "<ul class='latex-list' style='margin-left: 20px; margin-bottom: 10px;'>")
                .replace(/\\end\{itemize\}/g, "</ul>")
                .replace(/\\begin\{enumerate\}/g, "<ol class='latex-list' style='margin-left: 20px; margin-bottom: 10px;'>")
                .replace(/\\end\{enumerate\}/g, "</ol>")
                .replace(/\\item/g, "<li>")
                .replace(/\\\\/g, "<br>"); // D·ªãch d·∫•u xu·ªëng d√≤ng c·ªßa LaTeX
        }

        // --- T·∫¢I D·ªÆ LI·ªÜU JSON ---
        fetch('data.json')
            .then(response => response.json())
            .then(data => {
                problemsData = data;
                renderProblems(); 
            })
            .catch(error => console.error("L·ªói t·∫£i d·ªØ li·ªáu JSON:", error));

        // --- QU·∫¢N L√ù TI·∫æN ƒê·ªò L√ÄM B√ÄI ---
        function getCompletedProblems() {
            const saved = localStorage.getItem('toan_completed');
            return saved ? JSON.parse(saved) : [];
        }

        function saveCompletedProblem(id) {
            let completed = getCompletedProblems();
            if (!completed.includes(id)) {
                completed.push(id);
                localStorage.setItem('toan_completed', JSON.stringify(completed));
            }
        }

        function resetProgress() {
            if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ h·ªçc t·∫≠p kh√¥ng?")) {
                localStorage.removeItem('toan_completed');
                location.reload();
            }
        }

        // --- RENDER B√ÄI TO√ÅN RA M√ÄN H√åNH ---
        function renderProblems() {
            const containerTHPT = document.getElementById('THPT');
            const containerDGNL = document.getElementById('DGNL');
            containerTHPT.innerHTML = ''; 
            containerDGNL.innerHTML = '';

            const completedIds = getCompletedProblems();

            problemsData.forEach(item => {
                let questionHTML = '';
                
                // Ti·ªÅn x·ª≠ l√Ω vƒÉn b·∫£n LaTeX cho c√¢u h·ªèi v√† l·ªùi gi·∫£i
                const cauHoiDaXuLy = parseLaTeXText(item.cau_hoi);
                const loiGiaiDaXuLy = parseLaTeXText(item.loi_giai);

                // --- GIAO DI·ªÜN: 3 D·∫†NG C√ÇU H·ªéI ---
                // D·∫°ng 1: Tr·∫Øc nghi·ªám 4 ph∆∞∆°ng √°n
                if (item.loai_cau === '4_phuong_an') {
                    const lis = item.lua_chon.map(opt => {
                        const letter = opt.charAt(0); // L·∫•y ch·ªØ A, B, C, D
                        const textDaXuLy = parseLaTeXText(opt.substring(3)); // L·∫•y ph·∫ßn n·ªôi dung sau "A. "
                        return `<li style="list-style:none; margin-bottom:8px;">
                                    <label style="cursor:pointer; display:block; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:5px;">
                                        <input type="radio" name="q-${item.id}" value="${letter}" style="transform: scale(1.2); margin-right:8px;"> 
                                        <b>${letter}.</b> ${textDaXuLy}
                                    </label>
                                </li>`;
                    }).join('');
                    questionHTML = `<ul class="options-4" style="padding:0;">${lis}</ul>`;
                } 
                // D·∫°ng 2: Tr·∫Øc nghi·ªám ƒê√∫ng/Sai
                else if (item.loai_cau === 'dung_sai') {
                    const rows = item.cac_menh_de.map((md, idx) => {
                        const mdDaXuLy = parseLaTeXText(md.noi_dung);
                        return `
                        <tr>
                            <td style="padding:10px; border:1px solid #e2e8f0;">${mdDaXuLy}</td>
                            <td style="text-align:center; border:1px solid #e2e8f0;"><input type="radio" name="ds-${item.id}-${idx}" value="true" style="transform: scale(1.3);"> ƒê</td>
                            <td style="text-align:center; border:1px solid #e2e8f0;"><input type="radio" name="ds-${item.id}-${idx}" value="false" style="transform: scale(1.3);"> S</td>
                        </tr>`;
                    }).join('');
                    questionHTML = `<table class="table-tf" style="width:100%; border-collapse:collapse; margin-top:15px;">
                                        <tr style="background:#3b82f6; color:white;">
                                            <th style="padding:10px; border:1px solid #e2e8f0;">M·ªánh ƒë·ªÅ</th>
                                            <th style="padding:10px; border:1px solid #e2e8f0; text-align:center; width:60px;">ƒê√∫ng</th>
                                            <th style="padding:10px; border:1px solid #e2e8f0; text-align:center; width:60px;">Sai</th>
                                        </tr>
                                        ${rows}
                                    </table>`;
                } 
                // D·∫°ng 3: Tr·∫£ l·ªùi ng·∫Øn
                else if (item.loai_cau === 'tra_loi_ngan') {
                    questionHTML = `<div style="margin-top: 15px;">
                                        <input type="text" id="short-${item.id}" class="input-short" placeholder="Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n (VD: 12 ho·∫∑c e-1)" style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:5px; font-size:16px;">
                                    </div>`;
                }

                // --- KI·ªÇM TRA TR·∫†NG TH√ÅI HO√ÄN TH√ÄNH ---
                let isCompleted = completedIds.includes(item.id);
                let cardClass = isCompleted ? "card completed" : "card";
                let defaultFeedback = isCompleted ? '<span style="color:var(--success); font-weight:bold;">‚úÖ B·∫°n ƒë√£ l√†m ƒë√∫ng c√¢u n√†y!</span>' : '';

                // --- VIDEO YOUTUBE ---
                let youtubeHTML = '';
                if (item.youtube_id && item.youtube_id !== "") {
                    youtubeHTML = `<div class="video-container" style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:8px; margin-top:15px;">
                                       <iframe style="position:absolute; top:0; left:0; width:100%; height:100%;" src="https://www.youtube.com/embed/${item.youtube_id}" allowfullscreen></iframe>
                                   </div>`;
                }

                // --- G√ìI HTML V√ÄO TH·∫∫ CARD ---
                const cardHTML = `
                    <div id="card-${item.id}" class="${cardClass}" style="background:white; padding:25px; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-bottom:25px; border: 1px solid #e2e8f0;">
                        <div class="question" style="font-size:1.1rem; margin-bottom:15px;">
                            <strong>B√†i to√°n:</strong> ${cauHoiDaXuLy} 
                        </div>
                        
                        ${questionHTML}
                        
                        <div class="btn-group" style="margin-top:20px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <button class="check-btn" onclick="checkAnswer('${item.id}', '${item.loai_cau}')" style="background:#10b981; color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">Ki·ªÉm tra ƒë√°p √°n</button>
                            <button class="solution-btn" onclick="toggleSolution('${item.id}')" style="background:#3b82f6; color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">Xem l·ªùi gi·∫£i</button>
                            <span id="feedback-${item.id}" class="feedback-msg">${defaultFeedback}</span>
                        </div>
                        
                        <div class="solution-content" id="sol-${item.id}" style="display:none; margin-top:20px; padding:20px; background:#f0fdf4; border-left:4px solid #10b981; border-radius:0 5px 5px 0;">
                            <h4 style="color:#10b981; margin-bottom:10px;">L·ªùi gi·∫£i chi ti·∫øt:</h4>
                            <div>${loiGiaiDaXuLy}</div>
                            ${youtubeHTML}
                        </div>
                    </div>
                `;

                if (item.ky_thi === 'THPT') containerTHPT.innerHTML += cardHTML;
                else if (item.ky_thi === 'DGNL') containerDGNL.innerHTML += cardHTML;
            });

            // Sau khi Render HTML xong, g·ªçi MathJax ƒë·ªÉ v·∫Ω c√¥ng th·ª©c To√°n
            if (window.MathJax) MathJax.typesetPromise();
        }

        // --- H√ÄM KI·ªÇM TRA ƒê√ÅP √ÅN ---
        function checkAnswer(id, type) {
            const item = problemsData.find(p => p.id === id);
            const feedbackEl = document.getElementById(`feedback-${id}`);
            let isCorrect = false;

            if (type === '4_phuong_an') {
                const selected = document.querySelector(`input[name="q-${id}"]:checked`);
                if (!selected) return feedbackEl.innerHTML = '<span style="color:#f59e0b; font-weight:bold;">‚ö†Ô∏è Vui l√≤ng ch·ªçn 1 ƒë√°p √°n!</span>';
                if (selected.value === item.dap_an) isCorrect = true;
            } 
            else if (type === 'dung_sai') {
                let correctCount = 0; let allAnswered = true;
                item.cac_menh_de.forEach((md, idx) => {
                    const selected = document.querySelector(`input[name="ds-${id}-${idx}"]:checked`);
                    if (!selected) allAnswered = false;
                    else { if ((selected.value === 'true') === md.dap_an) correctCount++; }
                });
                if (!allAnswered) return feedbackEl.innerHTML = '<span style="color:#f59e0b; font-weight:bold;">‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒê/S cho t·∫•t c·∫£ m·ªánh ƒë·ªÅ!</span>';
                if (correctCount === item.cac_menh_de.length) isCorrect = true;
                else return feedbackEl.innerHTML = `<span style="color:#ef4444; font-weight:bold;">‚ùå ƒê√∫ng ${correctCount}/${item.cac_menh_de.length} √Ω. Th·ª≠ l·∫°i nh√©!</span>`;
            } 
            else if (type === 'tra_loi_ngan') {
                const inputVal = document.getElementById(`short-${id}`).value.trim();
                if (inputVal === '') return feedbackEl.innerHTML = '<span style="color:#f59e0b; font-weight:bold;">‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë√°p √°n!</span>';
                if (inputVal.toLowerCase().replace(/\s/g, '') === item.dap_an_ngan.toLowerCase().replace(/\s/g, '')) isCorrect = true;
            }

            if (isCorrect) {
                feedbackEl.innerHTML = '<span style="color:var(--success); font-weight:bold;">üéâ Ch√≠nh x√°c! B·∫°n l√†m r·∫•t t·ªët!</span>';
                saveCompletedProblem(id);
                // T·∫°o hi·ªáu ·ª©ng ho√†n th√†nh (ƒë·ªïi vi·ªÅn xanh)
                document.getElementById(`card-${id}`).style.borderColor = '#10b981';
            } else {
                feedbackEl.innerHTML = '<span style="color:#ef4444; font-weight:bold;">‚ùå Sai r·ªìi, th·ª≠ l·∫°i nh√©!</span>';
            }
        }

        // --- H√ÄM ·∫®N/HI·ªÜN L·ªúI GI·∫¢I ---
        function toggleSolution(id) {
            const solDiv = document.getElementById(`sol-${id}`);
            solDiv.style.display = solDiv.style.display === "block" ? "none" : "block";
        }

        // --- H√ÄM CHUY·ªÇN ƒê·ªîI TAB ---
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // M·ªü s·∫µn Tab m·∫∑c ƒë·ªãnh khi v·ª´a v√†o web
        document.getElementById("defaultOpen").click();
    </script>
</body>
</html>
