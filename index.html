<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ngân Hàng Toán THPT & ĐGNL</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

    <h1>Hệ Thống Luyện Thi Toán</h1>

    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'THPT')" id="defaultOpen">Kỳ thi THPT Quốc Gia</button>
        <button class="tablinks" onclick="openTab(event, 'DGNL')">Đánh Giá Năng Lực</button>
    </div>

    <div id="THPT" class="tabcontent"></div>
    <div id="DGNL" class="tabcontent"></div>
    <button class="reset-btn" onclick="resetProgress()">Xóa lịch sử làm bài</button>

    <script>
        let problemsData = [];

        fetch('data.json')
            .then(response => response.json())
            .then(data => { 
                problemsData = data; 
                renderProblems(); 
            })
            .catch(error => console.error("Lỗi tải dữ liệu JSON:", error));

        function getCompletedProblems() { return JSON.parse(localStorage.getItem('toan_completed') || '[]'); }
        function saveCompletedProblem(id) {
            let completed = getCompletedProblems();
            if (!completed.includes(id)) { completed.push(id); localStorage.setItem('toan_completed', JSON.stringify(completed)); }
        }
        function resetProgress() {
            if(confirm("Bạn có chắc muốn xóa lịch sử không?")) { localStorage.removeItem('toan_completed'); location.reload(); }
        }

        // ==========================================
        // BỘ CHUYỂN ĐỔI LATEX -> HTML THÔNG MINH
        // ==========================================
        function formatLaTeX(str) {
            if (!str) return "";

            str = str.replace(/\\begin\{tikzpicture\}([\s\S]*?)\\end\{tikzpicture\}/g, 
                "<script type='text/tikz'>\\begin{tikzpicture}$1\\end{tikzpicture}<\/script>");

            let mathBlocks = [];
            const mathRegex = /(<script type='text\/tikz'>[\s\S]*?<\/script>|\$\$[\s\S]*?\$\$|\$[\s\S]*?\$|\\begin\{(?:align\*?|equation\*?)\}[\s\S]*?\\end\{(?:align\*?|equation\*?)\})/g;
            
            str = str.replace(mathRegex, (match) => {
                mathBlocks.push(match);
                return `___MATH___${mathBlocks.length - 1}___`;
            });

            str = str.replace(/\\begin\{itemize\}/g, "<ul style='margin-left: 20px; margin-top: 5px;'>");
            str = str.replace(/\\end\{itemize\}/g, "</ul>");
            str = str.replace(/\\item/g, "<li>"); 
            str = str.replace(/\\\\/g, "<br>"); 
            str = str.replace(/\n/g, "<br>"); 

            str = str.replace(/(<br>\s*)+/g, "<br>"); 
            str = str.replace(/<ul><br>/g, "<ul>");
            str = str.replace(/<\/ul><br>/g, "</ul>");
            str = str.replace(/<li><br>/g, "<li>");

            str = str.replace(/___MATH___(\d+)___/g, (match, index) => {
                return mathBlocks[parseInt(index)];
            });

            return str;
        }

        // ==========================================
        // RENDER GIAO DIỆN VÀ GỌI THƯ VIỆN VẼ
        // ==========================================
        function renderProblems() {
            const containerTHPT = document.getElementById('THPT');
            const containerDGNL = document.getElementById('DGNL');
            containerTHPT.innerHTML = ''; containerDGNL.innerHTML = '';
            const completedIds = getCompletedProblems();

            problemsData.forEach(item => {
                let questionHTML = '';

                if (item.loai_cau === '4_phuong_an') {
                    const lis = item.lua_chon.map(opt => `<li><label><input type="radio" name="q-${item.id}" value="${opt.charAt(0)}"> ${opt}</label></li>`).join('');
                    questionHTML = `<ul class="options-4">${lis}</ul>`;
                } else if (item.loai_cau === 'dung_sai') {
                    const rows = item.cac_menh_de.map((md, idx) => `<tr><td>${formatLaTeX(md.noi_dung)}</td><td class="center"><input type="radio" name="ds-${item.id}-${idx}" value="true"> Đ</td><td class="center"><input type="radio" name="ds-${item.id}-${idx}" value="false"> S</td></tr>`).join('');
                    questionHTML = `<table class="table-tf"><tr><th>Mệnh đề</th><th class="center">Đúng</th><th class="center">Sai</th></tr>${rows}</table>`;
                } else if (item.loai_cau === 'tra_loi_ngan') {
                    questionHTML = `<input type="text" id="short-${item.id}" class="input-short" placeholder="Nhập đáp án (VD: 12 hoặc e-1)">`;
                }

                let isCompleted = completedIds.includes(item.id);
                let cardClass = isCompleted ? "problem-card completed" : "problem-card";
                let defaultFb = isCompleted ? '<span style="color:green;">✅ Hoàn thành!</span>' : '';
                let ytHTML = item.youtube_id ? `<div class="youtube-container"><iframe src="https://www.youtube.com/embed/${item.youtube_id}" allowfullscreen></iframe></div>` : '';

                const fmtCauHoi = formatLaTeX(item.cau_hoi);
                const fmtLoiGiai = formatLaTeX(item.loi_giai);

                const cardHTML = `
                    <div id="card-${item.id}" class="${cardClass}">
                        <div class="question">Bài toán: ${fmtCauHoi} <span class="badge-completed">Đã hoàn thành ✔️</span></div>
                        ${questionHTML}
                        <div class="btn-group">
                            <button class="check-btn" onclick="checkAnswer('${item.id}', '${item.loai_cau}')">Kiểm tra đáp án</button>
                            <button class="solution-btn" onclick="toggleSolution('${item.id}')">Xem lời giải</button>
                            <span id="feedback-${item.id}" class="feedback-msg">${defaultFb}</span>
                        </div>
                        <div class="solution-content" id="sol-${item.id}">
                            <strong>Lời giải chi tiết:</strong><p>${fmtLoiGiai}</p>${ytHTML}
                        </div>
                    </div>
                `;

                if (item.ky_thi === 'THPT') containerTHPT.innerHTML += cardHTML;
                else if (item.ky_thi === 'DGNL') containerDGNL.innerHTML += cardHTML;
            });

            // 1. Dịch công thức Toán
            if (window.MathJax) MathJax.typesetPromise();

        }

        // ==========================================
        // LOGIC CHẤM ĐIỂM
        // ==========================================
        function checkAnswer(id, type) {
            const item = problemsData.find(p => p.id === id);
            const fbEl = document.getElementById(`feedback-${id}`);
            let isCorrect = false;

            if (type === '4_phuong_an') {
                const sel = document.querySelector(`input[name="q-${id}"]:checked`);
                if (!sel) return fbEl.innerHTML = '<span style="color:orange;">Vui lòng chọn 1 đáp án!</span>';
                if (sel.value === item.dap_an) isCorrect = true;
            } else if (type === 'dung_sai') {
                let correctCount = 0; let allAnswered = true;
                item.cac_menh_de.forEach((md, idx) => {
                    const sel = document.querySelector(`input[name="ds-${id}-${idx}"]:checked`);
                    if (!sel) allAnswered = false;
                    else { if ((sel.value === 'true') === md.dap_an) correctCount++; }
                });
                if (!allAnswered) return fbEl.innerHTML = '<span style="color:orange;">Vui lòng chọn đủ Đ/S!</span>';
                if (correctCount === item.cac_menh_de.length) isCorrect = true;
                else return fbEl.innerHTML = `<span style="color:red;">❌ Đúng ${correctCount}/${item.cac_menh_de.length} ý.</span>`;
            } else if (type === 'tra_loi_ngan') {
                const val = document.getElementById(`short-${id}`).value.trim();
                if (val === '') return fbEl.innerHTML = '<span style="color:orange;">Vui lòng nhập đáp án!</span>';
                if (val.toLowerCase().replace(/\s/g, '') === item.dap_an_ngan.toLowerCase().replace(/\s/g, '')) isCorrect = true;
            }

            if (isCorrect) {
                fbEl.innerHTML = '<span style="color:green;">✅ Chính xác!</span>';
                saveCompletedProblem(id);
                document.getElementById(`card-${id}`).classList.add('completed');
            } else { fbEl.innerHTML = '<span style="color:red;">❌ Sai rồi, thử lại nhé!</span>'; }
        }

        function toggleSolution(id) {
            const s = document.getElementById(`sol-${id}`);
            s.style.display = s.style.display === "block" ? "none" : "block";
        }

        function openTab(evt, tabName) {
            document.querySelectorAll(".tabcontent").forEach(el => el.style.display = "none");
            document.querySelectorAll(".tablinks").forEach(el => el.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
        }

        document.getElementById("defaultOpen").click();
    </script>
</body>
</html>

