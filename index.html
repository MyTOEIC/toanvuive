<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ng√¢n H√†ng To√°n THPT & ƒêGNL</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
    <script src="https://tikzjax.com/v1/tikzjax.js"></script>

    <script>
        window.MathJax = {
            tex: { 
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                tags: 'ams'
            },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* CSS CHO B·ªê C·ª§C CHIA ƒê√îI M√ÄN H√åNH */
        .app-container { display: flex; flex-direction: row; gap: 20px; max-width: 1200px; margin: 0 auto; padding: 20px; align-items: flex-start; }
        
        /* C·ªòT TR√ÅI: DANH S√ÅCH B√ÄI T·∫¨P */
        .sidebar { width: 300px; flex-shrink: 0; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; display: flex; flex-direction: column; height: 80vh; overflow: hidden; position: sticky; top: 20px; }
        .search-box { padding: 15px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
        .search-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 5px; font-size: 15px; outline: none; }
        .search-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
        .problem-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .problem-tab-btn { display: block; width: 100%; text-align: left; padding: 12px 15px; margin-bottom: 5px; background: white; border: 1px solid transparent; border-radius: 6px; cursor: pointer; font-size: 15px; transition: 0.2s; color: #334155; }
        .problem-tab-btn:hover { background: #f1f5f9; }
        .problem-tab-btn.active { background: #eff6ff; border-color: #3b82f6; color: #1d4ed8; font-weight: bold; }
        
        /* C·ªòT PH·∫¢I: N·ªòI DUNG L√ÄM B√ÄI */
        .main-content { flex-grow: 1; min-width: 0; }

        /* T·ªëi ∆∞u hi·ªÉn th·ªã cho Mobile */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: 40vh; position: relative; top: 0; }
        }

        /* C√°c style hi·ªÉn th·ªã LaTeX */
        .math-text { white-space: pre-line; word-wrap: break-word; line-height: 1.6; }
        .latex-list { margin-left: 20px; text-align: left; display: block; margin-top: 5px; margin-bottom: 5px; }
        .latex-list li { margin-bottom: 5px; }
    </style>
</head>
<body>

    <h1 style="text-align: center; margin-top: 20px;">H·ªá Th·ªëng Luy·ªán Thi To√°n</h1>

    <div class="tab">
        <button class="tablinks active" onclick="switchKyThi('THPT', this)" id="defaultOpen">K·ª≥ thi THPT Qu·ªëc Gia</button>
        <button class="tablinks" onclick="switchKyThi('DGNL', this)">ƒê√°nh Gi√° NƒÉng L·ª±c</button>
    </div>

    <div class="app-container">
        
        <div class="sidebar">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç T√¨m ƒë·ªÅ b√†i ho·∫∑c s·ªë th·ª© t·ª±..." onkeyup="filterSidebar()">
            </div>
            <div class="problem-list" id="sidebarList">
                </div>
        </div>

        <div class="main-content" id="activeProblemArea">
            <h3 style="text-align:center; color:#64748b; margin-top: 50px;">ƒêang t·∫£i d·ªØ li·ªáu...</h3>
        </div>

    </div>

    <button class="reset-btn" onclick="resetProgress()" style="display:block; margin: 30px auto;">X√≥a l·ªãch s·ª≠ l√†m b√†i</button>

    <script>
        let allProblems = []; 
        let currentKyThi = 'THPT'; // Tab ƒëang ch·ªçn m·∫∑c ƒë·ªãnh
        let currentProblemId = null; // B√†i ƒëang m·ªü

        // --- 1. T·∫¢I D·ªÆ LI·ªÜU ---
        fetch('data.json')
            .then(res => res.json())
            .then(data => {
                allProblems = data;
                document.getElementById("defaultOpen").click(); // M·ªü tab THPT m·∫∑c ƒë·ªãnh
            })
            .catch(err => {
                document.getElementById('activeProblemArea').innerHTML = '<h3 style="color:red; text-align:center;">‚ùå L·ªói ƒë·ªçc file data.json! Ki·ªÉm tra l·∫°i c√∫ ph√°p.</h3>';
            });

        // --- 2. H√ÄM D·ªäCH LATEX ---
        function parseLaTeXText(text) {
            if (!text) return "";
            return text
                .replace(/\\begin\{itemize\}/g, "<ul class='latex-list'>")
                .replace(/\\end\{itemize\}/g, "</ul>")
                .replace(/\\begin\{enumerate\}/g, "<ol class='latex-list'>")
                .replace(/\\end\{enumerate\}/g, "</ol>")
                .replace(/\\item/g, "<li>");
        }

        // --- 3. QU·∫¢N L√ù TI·∫æN ƒê·ªò ---
        function getCompletedProblems() {
            return JSON.parse(localStorage.getItem('toan_completed') || '[]');
        }
        function saveCompletedProblem(id) {
            let completed = getCompletedProblems();
            if (!completed.includes(id)) {
                completed.push(id);
                localStorage.setItem('toan_completed', JSON.stringify(completed));
                // C·∫≠p nh·∫≠t l·∫°i thanh b√™n tr√°i cho hi·ªán d·∫•u check
                filterSidebar(); 
            }
        }
        function resetProgress() {
            if(confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠ h·ªçc t·∫≠p?")) {
                localStorage.removeItem('toan_completed');
                location.reload();
            }
        }

        // --- 4. CHUY·ªÇN TAB K·ª≤ THI CH√çNH ---
        window.switchKyThi = function(kyThi, btnElement) {
            currentKyThi = kyThi;
            
            // X·ª≠ l√Ω hi·ªáu ·ª©ng n√∫t Tab
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) tablinks[i].classList.remove("active");
            btnElement.classList.add("active");

            // L√†m s·∫°ch √¥ t√¨m ki·∫øm
            document.getElementById('searchInput').value = '';

            // L·ªçc v√† v·∫Ω l·∫°i Sidebar
            filterSidebar();
        };

        // --- 5. L·ªåC V√Ä V·∫º THANH SIDEBAR T√åM KI·∫æM ---
        window.filterSidebar = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sidebar = document.getElementById('sidebarList');
            sidebar.innerHTML = '';

            // L·∫•y danh s√°ch b√†i thu·ªôc k·ª≥ thi hi·ªán t·∫°i v√† kh·ªõp t·ª´ kh√≥a
            const filteredData = allProblems.filter(p => {
                const isMatchKyThi = p.ky_thi === currentKyThi;
                const isMatchSearch = p.cau_hoi.toLowerCase().includes(searchTerm) || p.id.toLowerCase().includes(searchTerm);
                return isMatchKyThi && isMatchSearch;
            });

            const completedIds = getCompletedProblems();

            if(filteredData.length === 0) {
                sidebar.innerHTML = '<p style="text-align:center; padding: 20px; color:#94a3b8;">Kh√¥ng t√¨m th·∫•y b√†i n√†o.</p>';
                document.getElementById('activeProblemArea').innerHTML = '';
                return;
            }

            // T·∫°o c√°c tab b√†i to√°n nh·ªè
            filteredData.forEach((p, index) => {
                const isCompleted = completedIds.includes(p.id) ? ' <span style="color:#10b981; float:right;">‚úîÔ∏è</span>' : '';
                const btn = document.createElement('button');
                btn.className = `problem-tab-btn ${p.id === currentProblemId ? 'active' : ''}`;
                
                // Ti√™u ƒë·ªÅ n√∫t tr√™n Sidebar (VD: B√†i 1, B√†i 2...)
                // C·∫Øt 30 k√Ω t·ª± ƒë·∫ßu c·ªßa c√¢u h·ªèi l√†m m√¥ t·∫£ ng·∫Øn
                let shortDesc = p.cau_hoi.replace(/(<([^>]+)>)/ig, "").substring(0, 25) + '...'; 
                btn.innerHTML = `<strong>B√†i ${index + 1}</strong> <br><span style="font-size:0.85em; color:#64748b; font-weight:normal;">${shortDesc}</span> ${isCompleted}`;
                
                btn.onclick = () => openProblem(p.id);
                sidebar.appendChild(btn);
            });

            // N·∫øu b√†i ƒëang m·ªü kh√¥ng n·∫±m trong k·∫øt qu·∫£ t√¨m ki·∫øm, t·ª± ƒë·ªông m·ªü b√†i ƒë·∫ßu ti√™n
            if (!filteredData.find(p => p.id === currentProblemId)) {
                openProblem(filteredData[0].id);
            }
        };

        // --- 6. M·ªû 1 B√ÄI TO√ÅN B√äN C·ªòT PH·∫¢I ---
        window.openProblem = function(id) {
            currentProblemId = id;
            
            // C·∫≠p nh·∫≠t class active cho sidebar
            const btns = document.querySelectorAll('.problem-tab-btn');
            btns.forEach(b => b.classList.remove('active'));
            // Render l·∫°i sidebar ƒë·ªÉ highlight ƒë√∫ng n√∫t
            const searchTerm = document.getElementById('searchInput').value;
            if(!searchTerm) filterSidebar(); // Ch·ªâ render l·∫°i active state n·∫øu kh√¥ng ƒëang search d·ªü

            const item = allProblems.find(p => p.id === id);
            if (!item) return;

            const area = document.getElementById('activeProblemArea');
            const cauHoiDaXuLy = parseLaTeXText(item.cau_hoi);
            const loiGiaiDaXuLy = parseLaTeXText(item.loi_giai);

            let questionHTML = '';
            // Form c√¢u h·ªèi (3 d·∫°ng)
            if (item.loai_cau === '4_phuong_an') {
                const lis = item.lua_chon.map(opt => `<li><label style="cursor:pointer; display:block; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:5px; margin-bottom:8px;"><input type="radio" name="q" value="${opt.charAt(0)}" style="transform: scale(1.2); margin-right:8px;"> ${parseLaTeXText(opt)}</label></li>`).join('');
                questionHTML = `<ul style="list-style:none; padding:0;">${lis}</ul>`;
            } else if (item.loai_cau === 'dung_sai') {
                const rows = item.cac_menh_de.map((md, idx) => `<tr><td style="padding:10px; border:1px solid #ccc;">${parseLaTeXText(md.noi_dung)}</td><td style="text-align:center; border:1px solid #ccc;"><input type="radio" name="ds-${idx}" value="true" style="transform: scale(1.3);"> ƒê</td><td style="text-align:center; border:1px solid #ccc;"><input type="radio" name="ds-${idx}" value="false" style="transform: scale(1.3);"> S</td></tr>`).join('');
                questionHTML = `<table style="width:100%; border-collapse:collapse; margin-top:10px;"><tr style="background:#3b82f6; color:white;"><th style="padding:10px; border:1px solid #ccc;">M·ªánh ƒë·ªÅ</th><th style="padding:10px; border:1px solid #ccc; width:60px;">ƒê√∫ng</th><th style="padding:10px; border:1px solid #ccc; width:60px;">Sai</th></tr>${rows}</table>`;
            } else if (item.loai_cau === 'tra_loi_ngan') {
                questionHTML = `<input type="text" id="short-ans" placeholder="Nh·∫≠p ƒë√°p √°n..." style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:5px; font-size:16px;">`;
            }

            let youtubeHTML = item.youtube_id ? `<div style="position:relative; padding-bottom:56.25%; height:0; margin-top:15px; border-radius:8px; overflow:hidden;"><iframe src="https://www.youtube.com/embed/${item.youtube_id}" style="position:absolute; top:0; left:0; width:100%; height:100%;" allowfullscreen></iframe></div>` : '';

            // B∆°m HTML v√†o c·ªôt ph·∫£i
            area.innerHTML = `
                <div style="background:#fff; padding:30px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.05); border:1px solid #e2e8f0;">
                    <span style="background:#e0e7ff; color:#1d4ed8; padding:4px 12px; border-radius:20px; font-size:13px; font-weight:bold; margin-bottom:15px; display:inline-block;">M√£ c√¢u h·ªèi: ${item.id}</span>
                    <div class="math-text" style="font-size:1.15rem; margin-bottom:20px;">${cauHoiDaXuLy}</div>
                    
                    <div style="background:#f8fafc; padding:20px; border-radius:8px; border:1px dashed #cbd5e1; margin-bottom:20px;">
                        ${questionHTML}
                    </div>
                    
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 15px;">
                        <button onclick="checkAnswer()" style="background:#10b981; color:white; border:none; padding:12px 24px; border-radius:5px; font-weight:bold; cursor:pointer; font-size:15px;">Ki·ªÉm tra ƒë√°p √°n</button>
                        <button onclick="toggleSolution()" style="background:#3b82f6; color:white; border:none; padding:12px 24px; border-radius:5px; font-weight:bold; cursor:pointer; font-size:15px;">Xem l·ªùi gi·∫£i</button>
                    </div>
                    
                    <div id="feedback-msg" style="font-weight:bold; font-size:1.1rem; margin-bottom:15px;"></div>
                    
                    <div id="sol-area" class="math-text" style="display:none; padding:20px; background:#f0fdf4; border-left:4px solid #10b981; border-radius:0 5px 5px 0;">
                        <h4 style="color:#10b981; margin-top:0;">L·ªùi gi·∫£i chi ti·∫øt:</h4>
                        <div>${loiGiaiDaXuLy}</div>
                        ${youtubeHTML}
                    </div>
                </div>
            `;

            // G·ªçi MathJax render To√°n cho ph·∫ßn b√™n ph·∫£i
            if (window.MathJax) MathJax.typesetPromise();
        };

        // --- 7. KI·ªÇM TRA ƒê√ÅP √ÅN ---
        window.checkAnswer = function() {
            const item = allProblems.find(p => p.id === currentProblemId);
            const feedbackEl = document.getElementById('feedback-msg');
            let isCorrect = false;

            if (item.loai_cau === '4_phuong_an') {
                const selected = document.querySelector(`input[name="q"]:checked`);
                if (!selected) return feedbackEl.innerHTML = '<span style="color:#f59e0b;">‚ö†Ô∏è Vui l√≤ng ch·ªçn 1 ƒë√°p √°n!</span>';
                if (selected.value === item.dap_an) isCorrect = true;
            } else if (item.loai_cau === 'dung_sai') {
                let correctCount = 0; let allAnswered = true;
                item.cac_menh_de.forEach((md, idx) => {
                    const selected = document.querySelector(`input[name="ds-${idx}"]:checked`);
                    if (!selected) allAnswered = false;
                    else if ((selected.value === 'true') === md.dap_an) correctCount++;
                });
                if (!allAnswered) return feedbackEl.innerHTML = '<span style="color:#f59e0b;">‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒê/S cho t·∫•t c·∫£!</span>';
                if (correctCount === item.cac_menh_de.length) isCorrect = true;
                else return feedbackEl.innerHTML = `<span style="color:#ef4444;">‚ùå ƒê√∫ng ${correctCount}/${item.cac_menh_de.length} √Ω.</span>`;
            } else if (item.loai_cau === 'tra_loi_ngan') {
                const inputVal = document.getElementById(`short-ans`).value.trim();
                if (inputVal === '') return feedbackEl.innerHTML = '<span style="color:#f59e0b;">‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë√°p √°n!</span>';
                if (inputVal.toLowerCase().replace(/\s/g, '') === item.dap_an_ngan.toLowerCase().replace(/\s/g, '')) isCorrect = true;
            }

            if (isCorrect) {
                feedbackEl.innerHTML = '<span style="color:#10b981;">üéâ Ch√≠nh x√°c! B·∫°n l√†m r·∫•t t·ªët!</span>';
                saveCompletedProblem(item.id);
            } else {
                feedbackEl.innerHTML = '<span style="color:#ef4444;">‚ùå Sai r·ªìi, th·ª≠ l·∫°i nh√©!</span>';
            }
        };

        // --- 8. ·∫®N HI·ªÜN L·ªúI GI·∫¢I ---
        window.toggleSolution = function() {
            const solDiv = document.getElementById(`sol-area`);
            solDiv.style.display = solDiv.style.display === "block" ? "none" : "block";
        };

    </script>
</body>
</html>
